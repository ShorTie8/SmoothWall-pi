#!/usr/bin/perl
#
# This code is distributed under the terms of the GPL
#
# (c) 2004-2008 marco.s - http://www.urlfilter.net
#
# $Id: urlfilter.dat,v 1.5 2008/05/17 00:00:00 marco.s Exp $
#

use POSIX();
use URI::Escape;

use lib "/usr/lib/smoothwall";
use header qw( :standard );
use strict;
use warnings;

my $dbdir = "${swroot}/urlfilter/blacklists";
my $logdir = "/var/log/squidGuard";

my (%cgiparams, %logsettings, %filtersettings, %selected, @ip, %ips, %categories, %usernames);
my (@log, @loginfo, @category, @then, @temp);

my $colourgreen = '#339933';
my $colourerr = '#FF0000';

$cgiparams{'ACTION'} = '';

my $infomessage='';
my $errormessage='';

my $logarch='';
my $date='';
my $time='';
my $pid='';
my $dsturl='';
my $site='';
my $attr1='';
my $attr2='';

my $lines=0;

my $day='';
my $daystr='';
my $month='';
my $longmonthstr='';

my $logday='';
my $logmonth='';
my $logyear='';

my @longmonths = ( $tr{'january'}, $tr{'february'}, $tr{'march'},
		   $tr{'april'}, $tr{'may'}, $tr{'june'}, $tr{'july'}, $tr{'august'},
		   $tr{'september'}, $tr{'october'}, $tr{'november'},
		   $tr{'december'} );

my @now = localtime(time);
my $year = $now[5]+1900;

$cgiparams{'DAY'} = $now[3];
$cgiparams{'MONTH'} = $now[4];
$cgiparams{'LOGTYPE'} = 'urlfilter';
$cgiparams{'CATEGORY'} = 'ALL';
$cgiparams{'SOURCE_IP'} = 'ALL';
$cgiparams{'USERNAME'} = 'ALL';

&getcgihash(\%cgiparams);

if (-e "${swroot}/urlfilter/settings") {
	&readhash("${swroot}/urlfilter/settings", \%filtersettings);
}

my $start = -1;

if ($ENV{'QUERY_STRING'} && $cgiparams{'ACTION'} ne $tr{'update'}) {
	my @temp = split(',',$ ENV{'QUERY_STRING'});
 	$start = $temp[0];
 	$cgiparams{'MONTH'} = $temp[1];
 	$cgiparams{'DAY'} = $temp[2];  
 	$cgiparams{'LOGTYPE'} = $temp[3];  
 	$cgiparams{'CATEGORY'} = $temp[4];  
 	$cgiparams{'SOURCE_IP'} = $temp[5];  
 	$cgiparams{'USERNAME'} = $temp[6];  
}

if (!($cgiparams{'MONTH'} =~ /^(0|1|2|3|4|5|6|7|8|9|10|11)$/) ||
    !($cgiparams{'DAY'} =~ /^(1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|30|31)$/)) {
	$cgiparams{'DAY'} = $now[3];
	$cgiparams{'MONTH'} = $now[4];
}

if ((($cgiparams{'MONTH'} eq $now[4]) && ($cgiparams{'DAY'} > $now[3])) || ($cgiparams{'MONTH'} > $now[4])) {
	$year = $now[5]+1899;
}

@then = localtime(POSIX::mktime( 0, 0, 0, 1, $cgiparams{'MONTH'}, $year - 1900 ) + (($cgiparams{'DAY'} -1) * 86400));
$cgiparams{'DAY'} = $then[3];
$cgiparams{'MONTH'} = $then[4];
$year = $then[5] + 1900;

$longmonthstr = $longmonths[$cgiparams{'MONTH'}];

$day = $cgiparams{'DAY'};
$daystr = ($day <= 9) ? "0$day" : $day;

&processevent;

if ($cgiparams{'ACTION'} eq $tr{'export'}) {
	print "Content-type: text/plain\n\n";
	print "Smmothwall URL filter log\r\n";
	print "Date: $year $longmonthstr $daystr\r\n"; 
	print "Section: $cgiparams{'LOGTYPE'}\r\n";
	unless ($cgiparams{'LOGTYPE'} eq 'squidGuard') {
		print "Category: $cgiparams{'CATEGORY'}\r\n"; 
		print "Client: $cgiparams{'SOURCE_IP'}\r\n"; 
		if ($filtersettings{'ENABLE_USERNAME_LOG'} eq 'on') {
			print "Username: $cgiparams{'USERNAME'}\r\n";
		}
	}
	print "\r\n";

	foreach (@log) {
		($date,$time,$pid,@loginfo) = split(/ /);
		chomp(@loginfo);
		@ip = split(/\//,$loginfo[2]);
		@category = split(/\//,$loginfo[0]);
		$dsturl = $loginfo[1];
		$loginfo[3] =~ s/\%5c/\\/;
		if ((($cgiparams{'CATEGORY'}  eq 'ALL') || ($category[1] eq $cgiparams{'CATEGORY'})) &&
		    (($cgiparams{'SOURCE_IP'} eq 'ALL') || ($ip[0] eq $cgiparams{'SOURCE_IP'})) &&
		    (($cgiparams{'USERNAME'}  eq 'ALL') || ($loginfo[3] eq $cgiparams{'USERNAME'}))) {
			print "$date ";
			print "$time ";
			if ($cgiparams{'LOGTYPE'} eq 'squidGuard') {
				print "$pid ";
				print "@loginfo";
	                	print "\n";
			}
			else {
				print "$category[1] ";
				print "$ip[0] ";
				print "$loginfo[3] " if ($filtersettings{'ENABLE_USERNAME_LOG'} eq 'on');
				print "$dsturl";
	                	print "\n";
			}
		}
	}
	exit;
}

&showhttpheaders();

&openpage($tr{'urlfilter log viewer'}, 1, '', 'logs');

&openbigbox('100%', 'LEFT');

&alertbox($errormessage, "", $infomessage);

&openbox($tr{'settingsc'});


$selected{'LOGTYPE'}{'urlfilter'} = '';
$selected{'LOGTYPE'}{'squidGuard'} = '';
$selected{'LOGTYPE'}{$cgiparams{'LOGTYPE'}} = "selected='selected'";

$selected{'CATEGORY'}{'ALL'} = '';
$selected{'CATEGORY'}{$cgiparams{'CATEGORY'}} = "selected='selected'";

$selected{'SOURCE_IP'}{'ALL'} = '';
$selected{'SOURCE_IP'}{$cgiparams{'SOURCE_IP'}} = "selected='selected'";

$selected{'USERNAME'}{'ALL'} = '';
$selected{'USERNAME'}{$cgiparams{'USERNAME'}} = "selected='selected'";

print <<END
<form method='post' action="$ENV{'SCRIPT_NAME'}">
<table style='width: 100%; border: none; margin-left:auto; margin-right:auto'>
<tr>
	<td style='width:8%;' class='base'>$tr{'section'}</td>
	<td style='width:15%;' class='base'>
	<select name='LOGTYPE' size='1'>
	<option $selected{'LOGTYPE'}{'urlfilter'} value='urlfilter'>$tr{'urlfilter url filter'}</option>
END
;
print <<END
	<option $selected{'LOGTYPE'}{'squidGuard'} value='squidGuard'>squidGuard</option>
	</select></td>
	<td style='width:8%;' class='base'>$tr{'month'}</td>
	<td style='width:15%;'>
	<select name='MONTH'>
END
;

for ($month = 0; $month < 12; $month++) {
	print "	<option ";
	print 'selected="selected" ' if ($month == $cgiparams{'MONTH'});
	print "value='$month'>$longmonths[$month]</option>\n";
}
print <<END
	</select></td>
	<td style='width:8%;' class='base'>$tr{'day'}</td>
	<td style='width:15%;'>
	<select name='DAY'>
END
;

for ($day = 1; $day <= 31; $day++)  {
	print "	<option ";
	print 'selected="selected" ' if ($day == $cgiparams{'DAY'});
	print "value='$day'>$day</option>\n";
}
print <<END
	</select></td>
	<td style='width:10%; text-align:center;'><input type='submit' name='ACTION' value='$tr{'update'}' /></td>
	<td style='width:10%; text-align:center;'><input type='submit' name='ACTION' value='$tr{'export'}' /></td>
</tr>
<tr>
	<td style='height:8px;'></td>
</tr>
<tr>
	<td style='width:8%;' class='base'>$tr{'urlfilter category'}:</td>
	<td style='width:20%;'>
	<select name='CATEGORY'>
	<option value='ALL' $selected{'CATEGORY'}{'ALL'}>$tr{'caps all'}</option>
END
;

foreach my $cat (sort(keys %categories)) {
	$selected{'CATEGORY'}{$cat} = '';
	print "	<option value='$cat' $selected{'CATEGORY'}{$cat}>$cat</option>\n";
}
print <<END
	</select></td>
	<td style='width:8%;' class='base'>$tr{'urlfilter client'}:</td>
END
;

if ($filtersettings{'ENABLE_USERNAME_LOG'} eq 'on') {
	print "	<td style='width:20%;'>\n";
}
else {
	print "	<td>\n";
}
print <<END
	<select name='SOURCE_IP'>
	<option value='ALL' $selected{'SOURCE_IP'}{'ALL'}>$tr{'caps all'}</option>
END
;

foreach my $ipaddr (sort(keys %ips)) {
	$selected{'SOURCE_IP'}{$ipaddr} = '';
	print "	<option value='$ipaddr' $selected{'SOURCE_IP'}{$ipaddr}>$ipaddr</option>\n";
}
print <<END
	</select></td>
END
;

if ($filtersettings{'ENABLE_USERNAME_LOG'} eq 'on') {
	print <<END
	<td style='width:10%;' class='base'>$tr{'urlfilter username'}:</td>
	<td>
	<select name='USERNAME'>
	<option value='ALL' $selected{'USERNAME'}{'ALL'}>$tr{'caps all'}</option>
END
;

	foreach my $user (sort(keys %usernames)) {
		$selected{'USERNAME'}{$user} = '';
		print "	<option value='$user' $selected{'USERNAME'}{$user}>$user</option>\n";
	}
	print <<END
	</select></td>
END
;
}

print <<END
</tr>
</table>
</form>
END
;

&closebox();

&openbox($tr{'log'}.":");

$lines = @log;

$start = $lines - $viewsize if ($start == -1);
$start = $lines - $viewsize if ($start >= $lines - $viewsize);
$start = 0 if ($start < 0);

my $prev = $start - $viewsize;
my $next = $start + $viewsize;

$prev = 0 if ($prev < 0);
$next = -1 if ($next >= $lines);
$prev = -1 if ($start == 0);

if ($cgiparams{'LOGTYPE'} eq 'urlfilter') {
	print "<p><b>$tr{'urlfilter web hits'} $year $longmonthstr $daystr: $lines</b>\n<p>\n";
}

my @slice = splice(@log, $start, $viewsize);

if ($lines) {
	$lines = 0;

	print "<table class='centered'>\n";
	unless ($cgiparams{'LOGTYPE'} eq 'squidGuard') {
		print "<tr>\n";
		print "<th style='text-align:center; font-weight:bold;'>$tr{'urlfilter time'}</th>\n";
		print "<th style='text-align:center; font-weight:bold;'>$tr{'urlfilter category'}</th>\n";
		print "<th style='text-align:center; font-weight:bold;'>$tr{'urlfilter client'}</th>\n";
		if ($filtersettings{'ENABLE_USERNAME_LOG'} eq 'on') {
			print "<th style='text-align:center; font-weight:bold;'>$tr{'urlfilter username'}</th>\n";
		}
		print "<th style='text-align:center; font-weight:bold;'>$tr{'urlfilter dst'}</th>\n";
		print "</tr>\n";
	}

	foreach (@slice) {
		$attr1 = '';
		$attr2 = '';
		($date, $time, $pid, @loginfo) = split(/ /);
		@ip = split(/\//,$loginfo[2]);
		@category = split(/\//,$loginfo[0]);
		$dsturl = $loginfo[1];
		$loginfo[3] =~ s/\%5c/\\/ if ($loginfo[3]);
		if ((($cgiparams{'CATEGORY'}  eq 'ALL') || ($category[1] eq $cgiparams{'CATEGORY'})) &&
		    (($cgiparams{'SOURCE_IP'} eq 'ALL') || ($ip[0] eq $cgiparams{'SOURCE_IP'})) &&
		    (($cgiparams{'USERNAME'}  eq 'ALL') || ($loginfo[3] eq $cgiparams{'USERNAME'}))) {
			$lines++;
			if ($cgiparams{'LOGTYPE'} eq 'squidGuard') {
				if ($loginfo[0] =~ /squidGuard/) {
					$attr1 .= "<span style='font-weight:bold;'>"; $attr2 .= "</span>";
				}
				if ($loginfo[1] =~ /ready/) {
					$attr1 .= "<span style='font-weight:bold; color:$colourgreen;'>"; $attr2 .= "</span>";
				}
				if ($loginfo[2] =~ /emergency/) {
					$attr1 .= "<span style='font-weight:bold; color:$colourerr;'>"; $attr2 .= "</span>";
				}
				print "<tr>\n";
			}
			else {
				if ($lines % 2) {
					print "<tr class='light'>\n"; 
				}
				else {
					print "<tr class='dark'>\n"; 
				} 
			}
			if ($cgiparams{'LOGTYPE'} eq 'squidGuard') {
				print "<td>$time &nbsp; $pid &nbsp; $attr1@loginfo$attr2</td>\n";
			}
			else {
				print "<td style='width:10%; text-align:center; white-space:nowrap;'>$time</td>\n";
				print "<td style='width:11%; text-align:center; white-space:nowrap;'>$category[1]</td>\n";
				print "<td style='width:15%; text-align:center; white-space:nowrap;'>$ip[0]</td>\n";
				if ($filtersettings{'ENABLE_USERNAME_LOG'} eq 'on') {
					print "<td style='width:12%; text-align:center; white-space:nowrap;'>$loginfo[3]</td>\n";
					$site = substr($dsturl,0,55);
					$site .= "..." if (length($dsturl) > 55);
				}
				else {
					$site = substr($dsturl,0,69);
					$site .= "..." if (length($dsturl) > 69);
				}
				$dsturl =~ s/'/%27/g;
				print "<td><a href='$dsturl' title='$dsturl' onclick='window.open(this.href); return false'>$site</a></td>\n";
			}
			print "</tr>\n";
		}
	}
	print "</table><br>\n";
}

if ($lines) {
	&oldernewer();
}

&closebox();
&closebigbox();
&closepage();

# -------------------------------------------------------------------

sub processevent
{
	my $filestr='';

	@log = ();
	if ($cgiparams{'LOGTYPE'} eq 'squidGuard') {
		$filestr = "$logdir/squidGuard.log";
		foreach $logarch (<$filestr.*.gz>) {
			open (LOG,"gzip -dc $logarch |");
			foreach (<LOG>) {
				($date,$time,$pid,@loginfo) = split(/ /);
				($logyear,$logmonth,$logday) = split(/-/,$date);
				if (($logyear == $year) && ($logmonth == $cgiparams{'MONTH'}+1) && ($logday == $day)) {
					push(@log,$_);
				}
			}
			close(LOG);
		}
		open (LOG,$filestr);
		foreach (<LOG>) {
			($date,$time,$pid,@loginfo) = split(/ /);
			($logyear,$logmonth,$logday) = split(/-/,$date);
			if (($logyear == $year) && ($logmonth == $cgiparams{'MONTH'}+1) && ($logday == $day)) {
				push(@log,$_);
			}
		}
		close(LOG);
	}
	else {
		foreach $logarch (<$logdir/*.gz>) {
			if ($logarch !~ /squidGuard\.log/) {
				open (LOG,"gzip -dc $logarch |");
				foreach (<LOG>) {
					($date,$time,$pid,@loginfo) = split(/ /);
					($logyear,$logmonth,$logday) = split(/-/,$date);
					@category = split(/\//,$loginfo[0]);
					$categories{$category[1]}++;
					@ip = split(/\//,$loginfo[2]);
					$ips{$ip[0]}++;
					$loginfo[3] =~ s/\%5c/\\/;
					$usernames{$loginfo[3]}++;
					if (($logyear == $year) && ($logmonth == $cgiparams{'MONTH'}+1) && ($logday == $day)) {
						push(@log,$_)
					}
				}
				close(LOG);
			}
		}
		foreach $filestr (<$logdir/*.log>) {
			if ($filestr !~ /squidGuard\.log/) {
				open (LOG,$filestr);
				foreach (<LOG>) {
					($date,$time,$pid,@loginfo) = split(/ /);
					($logyear,$logmonth,$logday) = split(/-/,$date);
					@category = split(/\//,$loginfo[0]);
					$categories{$category[1]}++;
					@ip = split(/\//,$loginfo[2]);
					$ips{$ip[0]}++;
					$loginfo[3] =~ s/\%5c/\\/;
					$usernames{$loginfo[3]}++;
					if (($logyear == $year) && ($logmonth == $cgiparams{'MONTH'}+1) && ($logday == $day)) {
						push(@log,$_);
					}
				}
				close(LOG);
			}
		}
		@temp = ();
		foreach (@log) {
			($date,$time,$pid,@loginfo) = split(/ /);
			@ip = split(/\//,$loginfo[2]);
			@category = split(/\//,$loginfo[0]);
			$loginfo[3] =~ s/\%5c/\\/;
			if ((($cgiparams{'CATEGORY'}  eq 'ALL') || ($category[1] eq $cgiparams{'CATEGORY'})) &&
			    (($cgiparams{'SOURCE_IP'} eq 'ALL') || ($ip[0] eq $cgiparams{'SOURCE_IP'})) &&
			    (($cgiparams{'USERNAME'}  eq 'ALL') || ($loginfo[3] eq $cgiparams{'USERNAME'}))) {
				push(@temp,$_);
			}
		}
		@log = @temp;
		@log = sort { substr($a,11,8) cmp substr($b,11,8) } @log; 

	}
}

# -------------------------------------------------------------------

sub oldernewer
{
	print "<table style='width: 100%; border: none; margin-left:auto; margin-right:auto'>";
	print "<tr>";

	print "	<td style='width:50%; text-align:center'>";
	if ($prev != -1) {
		print "<a href='$ENV{'SCRIPT_NAME'}?$prev,$cgiparams{'MONTH'},$cgiparams{'DAY'},$cgiparams{'LOGTYPE'},$cgiparams{'CATEGORY'},$cgiparams{'SOURCE_IP'},$cgiparams{'USERNAME'}'>$tr{'older'}</a>"; }
	else {
		print "$tr{'older'}";
	}
	print "	</td>\n";

	print "	<td style='width:50%; text-align:center'>";
	if ($next != -1) {
		print "<a href='$ENV{'SCRIPT_NAME'}?$next,$cgiparams{'MONTH'},$cgiparams{'DAY'},$cgiparams{'LOGTYPE'},$cgiparams{'CATEGORY'},$cgiparams{'SOURCE_IP'},$cgiparams{'USERNAME'}'>$tr{'newer'}</a>"; }
	else {
	        print "$tr{'newer'}";
	}
	print "	</td>\n";
	print "</tr>";
	print "</table>";
}

# -------------------------------------------------------------------
